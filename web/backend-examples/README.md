# Backend API Example

This directory contains example backend API implementations that can validate Azure Entra ID tokens from the React web application.

## Environment Variables

Create a `.env` file based on the `.env.example` file generated by the setup script:

```env
# Azure App Registration Configuration
WEB_APP_CLIENT_ID=your-web-app-id
API_APP_CLIENT_ID=your-api-app-id
TENANT_ID=your-tenant-id

# API Configuration
API_PORT=8080
API_BASE_URL=http://localhost:8080
CORS_ORIGINS=http://localhost:3000
```

## Implementation Examples

### Node.js/Express Example

```javascript
const express = require('express');
const jwt = require('jsonwebtoken');
const jwksClient = require('jwks-rsa');
const cors = require('cors');
require('dotenv').config();

const app = express();

// CORS configuration
app.use(cors({
    origin: process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'],
    credentials: true
}));

app.use(express.json());

// JWKS client for validating Azure AD tokens
const client = jwksClient({
    jwksUri: `https://login.microsoftonline.com/${process.env.TENANT_ID}/discovery/v2.0/keys`
});

function getKey(header, callback) {
    client.getSigningKey(header.kid, (err, key) => {
        const signingKey = key.publicKey || key.rsaPublicKey;
        callback(null, signingKey);
    });
}

// Middleware to validate Azure AD tokens
const validateToken = (req, res, next) => {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return res.status(401).json({ error: 'No valid authorization header' });
    }

    const token = authHeader.substring(7);

    jwt.verify(token, getKey, {
        audience: `api://${process.env.API_APP_CLIENT_ID}`,
        issuer: `https://login.microsoftonline.com/${process.env.TENANT_ID}/v2.0`,
        algorithms: ['RS256']
    }, (err, decoded) => {
        if (err) {
            console.error('Token validation error:', err);
            return res.status(401).json({ error: 'Invalid token' });
        }

        req.user = decoded;
        next();
    });
};

// Protected API endpoint
app.get('/api/test', validateToken, (req, res) => {
    res.json({
        message: 'Hello from the protected API!',
        user: {
            name: req.user.name,
            email: req.user.preferred_username,
            objectId: req.user.oid
        },
        timestamp: new Date().toISOString(),
        tokenInfo: {
            audience: req.user.aud,
            issuer: req.user.iss,
            scopes: req.user.scp?.split(' ') || []
        }
    });
});

// Health check endpoint
app.get('/health', (req, res) => {
    res.json({ status: 'healthy', timestamp: new Date().toISOString() });
});

const port = process.env.API_PORT || 8080;
app.listen(port, () => {
    console.log(`API server running on http://localhost:${port}`);
    console.log(`Accepting tokens for audience: api://${process.env.API_APP_CLIENT_ID}`);
    console.log(`Tenant ID: ${process.env.TENANT_ID}`);
});
```

### Python/FastAPI Example

```python
from fastapi import FastAPI, HTTPException, Depends, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi.middleware.cors import CORSMiddleware
import jwt
import requests
import os
from datetime import datetime
from typing import Dict, Any

app = FastAPI(title="FastMCP Auth API")

# CORS configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=os.getenv("CORS_ORIGINS", "http://localhost:3000").split(","),
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

security = HTTPBearer()

# Cache for JWKS keys
jwks_cache = {}

def get_signing_key(kid: str, tenant_id: str) -> str:
    """Get the signing key for token validation"""
    if kid not in jwks_cache:
        jwks_url = f"https://login.microsoftonline.com/{tenant_id}/discovery/v2.0/keys"
        response = requests.get(jwks_url)
        jwks = response.json()
        
        for key in jwks["keys"]:
            if key["kid"] == kid:
                jwks_cache[kid] = key
                break
        else:
            raise HTTPException(status_code=401, detail="Unable to find signing key")
    
    return jwks_cache[kid]

async def validate_token(credentials: HTTPAuthorizationCredentials = Depends(security)) -> Dict[str, Any]:
    """Validate Azure AD token"""
    token = credentials.credentials
    tenant_id = os.getenv("TENANT_ID")
    api_client_id = os.getenv("API_APP_CLIENT_ID")
    
    try:
        # Decode header to get key ID
        header = jwt.get_unverified_header(token)
        signing_key = get_signing_key(header["kid"], tenant_id)
        
        # Construct public key
        public_key = jwt.algorithms.RSAAlgorithm.from_jwk(signing_key)
        
        # Verify and decode token
        payload = jwt.decode(
            token,
            public_key,
            algorithms=["RS256"],
            audience=f"api://{api_client_id}",
            issuer=f"https://login.microsoftonline.com/{tenant_id}/v2.0"
        )
        
        return payload
        
    except jwt.InvalidTokenError as e:
        raise HTTPException(status_code=401, detail=f"Invalid token: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=401, detail=f"Token validation failed: {str(e)}")

@app.get("/api/test")
async def test_endpoint(user: Dict[str, Any] = Depends(validate_token)):
    """Protected endpoint that returns user info and timestamp"""
    return {
        "message": "Hello from the protected API!",
        "user": {
            "name": user.get("name"),
            "email": user.get("preferred_username"),
            "object_id": user.get("oid")
        },
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "token_info": {
            "audience": user.get("aud"),
            "issuer": user.get("iss"),
            "scopes": user.get("scp", "").split(" ") if user.get("scp") else []
        }
    }

@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }

if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("API_PORT", 8080))
    uvicorn.run(app, host="0.0.0.0", port=port)
```

## Required Dependencies

### Node.js
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.0",
    "jwks-rsa": "^3.0.1",
    "cors": "^2.8.5",
    "dotenv": "^16.0.3"
  }
}
```

### Python
```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-jose[cryptography]==3.3.0
PyJWT==2.8.0
requests==2.31.0
python-dotenv==1.0.0
```

## Key Validation Points

1. **Audience Validation**: Token must be issued for your API (`api://your-api-app-id`)
2. **Issuer Validation**: Token must be issued by Azure AD for your tenant
3. **Signature Validation**: Token must be signed with Azure's private key
4. **Expiration Check**: Token must not be expired
5. **Scope Validation**: Optional - check if user has required permissions

## Testing

Once your backend is running on http://localhost:8080, you can test it from the React application using the "Call Backend API" button in the authenticated view.
